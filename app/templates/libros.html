<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- ============================================
          LIBRARY - Books Management
          Full CRUD + sorting + search
          ============================================ -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Libros - Biblioteca</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
    <script src="/static/js/main.js"></script>
  </head>
  <body>
    <!-- ========== HEADER ========== -->
    <header>
      <h1>üìñ Gesti√≥n de Libros</h1>
      <p>Inventario, ordenamientos y b√∫squedas</p>
    </header>

    <!-- ========== NAVIGATION ========== -->
    <nav>
      <a href="/">üè† Inicio</a>
      <a href="/templates/libros" class="active">üìñ Libros</a>
      <a href="/templates/usuarios">üë§ Usuarios</a>
      <a href="/templates/prestamos">üìã Pr√©stamos</a>
      <a href="/templates/reservas">üîñ Reservas</a>
      <a href="/templates/estanterias">üìö Estanter√≠as</a>
    </nav>

    <!-- ========== MAIN CONTENT ========== -->
    <div class="container">
      <!-- ===== SECTION: Book List ===== -->
      <div class="section fade-in">
        <h2>üìö Lista de Libros</h2>

        <!-- Action buttons to load and sort -->
        <div class="form-group">
          <button onclick="cargarLibros()">üìã Cargar Todos</button>
          <button onclick="ordenarPorISBN()" class="btn-success">
            üî¢ Ordenar por ISBN
          </button>
          <button onclick="ordenarPorPrecio()" class="btn-warning">
            üí∞ Ordenar por Precio
          </button>
        </div>

        <!-- Linear search by title/author -->
        <div class="form-group">
          <input
            type="text"
            id="buscar-texto"
            placeholder="Buscar por t√≠tulo o autor..."
          />
          <button onclick="buscarLineal()">üîç Buscar</button>
        </div>

        <!-- Results table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ISBN</th>
                <th>T√≠tulo</th>
                <th>Autor</th>
                <th>Peso (Kg)</th>
                <th>Valor (COP)</th>
                <th>Stock</th>
              </tr>
            </thead>
            <tbody id="tabla-libros">
              <!-- Los datos se cargan din√°micamente -->
            </tbody>
          </table>
        </div>

        <!-- Loading indicator -->
        <div id="loading-libros" class="loading">Cargando...</div>
      </div>

      <!-- ===== SECTION: Add New Book ===== -->
      <div class="section fade-in">
        <h2>‚ûï Agregar Nuevo Libro</h2>

        <div class="form-group">
          <input type="text" id="isbn" placeholder="ISBN" />
          <input type="text" id="titulo" placeholder="T√≠tulo" />
          <input type="text" id="autor" placeholder="Autor" />
        </div>

        <div class="form-group">
          <input type="number" id="peso" placeholder="Peso (Kg)" step="0.1" />
          <input type="number" id="valor" placeholder="Valor (COP)" />
          <input type="number" id="stock" placeholder="Stock" value="1" />
        </div>

        <div class="form-group">
          <input type="number" id="paginas" placeholder="P√°ginas" value="100" />
          <input type="text" id="editorial" placeholder="Editorial" />
          <input type="text" id="idioma" placeholder="Idioma" value="Espa√±ol" />
        </div>

        <button onclick="crearLibro()" class="btn-success">
          ‚úÖ Crear Libro
        </button>
      </div>

      <!-- ===== SECTION: Author Recursion ===== -->
      <div class="section fade-in">
        <h2>üìä C√°lculos por Autor (Recursi√≥n)</h2>

        <div class="form-group">
          <input
            type="text"
            id="autor-calculo"
            placeholder="Nombre del autor"
          />
          <button onclick="valorTotalAutor()">üíµ Valor Total</button>
          <button onclick="pesoPromedioAutor()" class="btn-warning">
            ‚öñÔ∏è Peso Promedio
          </button>
        </div>

        <!-- Resultado del c√°lculo -->
        <div
          id="resultado-autor"
          class="alert alert-info"
          style="display: none"
        ></div>
      </div>
    </div>

    <!-- ========== FOOTER ========== -->
    <footer>
      <p>Sistema de Gesti√≥n de Biblioteca ¬© 2025</p>
    </footer>

    <!-- ========== SCRIPTS ========== -->
    <script>
      // API base URL
      const API_BASE = "http://127.0.0.1:8000";

      /**
       * Load all books from the API
       * Uses: GET /libros/
       */
      async function cargarLibros() {
        mostrarLoading("loading-libros", true);
        try {
          const datos = await fetchAPI(`${API_BASE}/libros/`);
          renderTablaLibros(datos);
        } catch (error) {
          mostrarError("Error al cargar libros");
        }
        mostrarLoading("loading-libros", false);
      }

      /**
       * Sort books by ISBN (Insertion Sort)
       * Uses: GET /libros/ordenados/isbn
       */
      async function ordenarPorISBN() {
        mostrarLoading("loading-libros", true);
        try {
          const datos = await fetchAPI(`${API_BASE}/libros/ordenados/isbn`);
          renderTablaLibros(datos);
          mostrarExito("Libros ordenados por ISBN (Insertion Sort)");
        } catch (error) {
          mostrarError("Error al ordenar por ISBN");
        }
        mostrarLoading("loading-libros", false);
      }

      /**
       * Sort books by price/value (Merge Sort)
       * Uses: GET /libros/ordenados/precio
       */
      async function ordenarPorPrecio() {
        mostrarLoading("loading-libros", true);
        try {
          const datos = await fetchAPI(`${API_BASE}/libros/ordenados/precio`);
          renderTablaLibros(datos);
          mostrarExito("Libros ordenados por Precio (Merge Sort)");
        } catch (error) {
          mostrarError("Error al ordenar por precio");
        }
        mostrarLoading("loading-libros", false);
      }

      /**
       * Linear search by title or author
       * Uses: GET /libros/buscar?q=texto
       */
      async function buscarLineal() {
        const texto = document.getElementById("buscar-texto").value.trim();
        if (!texto) {
          mostrarError("Ingresa un t√©rmino de b√∫squeda");
          return;
        }

        mostrarLoading("loading-libros", true);
        try {
          const datos = await fetchAPI(
            `${API_BASE}/libros/buscar?q=${encodeURIComponent(texto)}`
          );
          renderTablaLibros(datos);
          mostrarExito(`Se encontraron ${datos.length} resultado(s)`);
        } catch (error) {
          renderTablaLibros([]);
          mostrarError("No se encontraron coincidencias");
        }
        mostrarLoading("loading-libros", false);
      }

      /**
       * Create a new book
       * Uses: POST /libros/
       */
      async function crearLibro() {
        const data = {
          isbn: document.getElementById("isbn").value,
          titulo: document.getElementById("titulo").value,
          autor: document.getElementById("autor").value,
          peso: parseFloat(document.getElementById("peso").value) || 0,
          valor: parseInt(document.getElementById("valor").value) || 0,
          stock: parseInt(document.getElementById("stock").value) || 1,
          paginas: parseInt(document.getElementById("paginas").value) || 100,
          editorial: document.getElementById("editorial").value || "N/A",
          idioma: document.getElementById("idioma").value || "Espa√±ol",
          estanteria: 0,
        };

        if (!data.isbn || !data.titulo || !data.autor) {
          mostrarError("ISBN, T√≠tulo y Autor son obligatorios");
          return;
        }

        try {
          await fetchAPI(`${API_BASE}/libros/`, "POST", data);
          mostrarExito("Libro creado exitosamente");
          limpiarFormularioLibro();
          cargarLibros();
        } catch (error) {
          mostrarError("Error al crear el libro (¬øISBN duplicado?)");
        }
      }

      /**
       * Calculate total value of books by author (Stack recursion)
       * Uses: GET /libros/autor/{autor}/valor-total
       */
      async function valorTotalAutor() {
        const autor = document.getElementById("autor-calculo").value.trim();
        if (!autor) {
          mostrarError("Ingresa el nombre del autor");
          return;
        }

        try {
          const datos = await fetchAPI(
            `${API_BASE}/libros/autor/${encodeURIComponent(autor)}/valor-total`
          );
          mostrarResultadoAutor(`
                    <strong>Autor:</strong> ${datos.autor}<br>
                    <strong>Valor Total:</strong> $${datos.valor_total.toLocaleString()} COP<br>
                    <strong>Libros:</strong> ${datos.libros.join(", ")}
                `);
        } catch (error) {
          mostrarError("Autor no encontrado");
        }
      }

      /**
       * Calculate average weight of books by author (Tail recursion)
       * Uses: GET /libros/autor/{autor}/peso-promedio
       */
      async function pesoPromedioAutor() {
        const autor = document.getElementById("autor-calculo").value.trim();
        if (!autor) {
          mostrarError("Ingresa el nombre del autor");
          return;
        }

        try {
          const datos = await fetchAPI(
            `${API_BASE}/libros/autor/${encodeURIComponent(
              autor
            )}/peso-promedio`
          );
          mostrarResultadoAutor(`
                    <strong>Autor:</strong> ${datos.autor}<br>
                    <strong>Peso Promedio:</strong> ${datos.peso_promedio.toFixed(
                      2
                    )} Kg<br>
                    <strong>Libros:</strong> ${datos.libros.join(", ")}
                `);
        } catch (error) {
          mostrarError("Autor no encontrado");
        }
      }

      // ========== HELPER FUNCTIONS ==========

      /**
       * Render the books table with received data
       */
      function renderTablaLibros(libros) {
        const tabla = document.getElementById("tabla-libros");
        tabla.innerHTML = "";

        libros.forEach((libro) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${libro.isbn}</td>
                    <td>${libro.titulo}</td>
                    <td>${libro.autor}</td>
                    <td>${libro.peso}</td>
                    <td>$${parseInt(libro.valor).toLocaleString()}</td>
                    <td><span class="badge ${
                      libro.stock > 0 ? "badge-success" : "badge-danger"
                    }">${libro.stock}</span></td>
                `;
          tabla.appendChild(tr);
        });
      }

      function limpiarFormularioLibro() {
        ["isbn", "titulo", "autor", "peso", "valor"].forEach((id) => {
          document.getElementById(id).value = "";
        });
      }

      function mostrarResultadoAutor(html) {
        const div = document.getElementById("resultado-autor");
        div.innerHTML = html;
        div.style.display = "block";
        div.className = "alert alert-success";
      }

      function mostrarLoading(id, show) {
        const el = document.getElementById(id);
        if (el) el.classList.toggle("active", show);
      }

      function mostrarExito(msg) {
        alert("‚úÖ " + msg);
      }

      function mostrarError(msg) {
        alert("‚ùå " + msg);
      }

      // Load books on page start
      document.addEventListener("DOMContentLoaded", cargarLibros);
    </script>
  </body>
</html>
