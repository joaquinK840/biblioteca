<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- ============================================
          LIBRARY - Shelves Module
          Algorithms: Brute Force and Backtracking
          ============================================ -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Estanter√≠as - Biblioteca</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
    <script src="/static/js/main.js"></script>
  </head>
  <body>
    <!-- ========== HEADER ========== -->
    <header>
      <h1>üìö M√≥dulo de Estanter√≠as</h1>
      <p>Algoritmos de asignaci√≥n: Fuerza Bruta y Backtracking</p>
    </header>

    <!-- ========== NAVIGATION ========== -->
    <nav>
      <a href="/">üè† Inicio</a>
      <a href="/templates/libros">üìñ Libros</a>
      <a href="/templates/usuarios">üë§ Usuarios</a>
      <a href="/templates/prestamos">üìã Pr√©stamos</a>
      <a href="/templates/reservas">üîñ Reservas</a>
      <a href="/templates/estanterias" class="active">üìö Estanter√≠as</a>
    </nav>

    <!-- ========== MAIN CONTENT ========== -->
    <div class="container">
      <!-- ===== SECTION: Brute Force ===== -->
      <div class="section fade-in">
        <h2>‚ö†Ô∏è Fuerza Bruta ‚Äì Combinaciones Peligrosas</h2>
        <p>
          Este algoritmo explora <strong>exhaustivamente</strong> todas las
          combinaciones posibles de <strong>4 libros</strong> y lista aquellas
          cuyo peso total supera los <strong>8 Kg</strong>
          (umbral de riesgo para un estante).
        </p>
        <p>
          <em
            >Complejidad: O(n‚Å¥) - Explora todas las combinaciones sin
            optimizaci√≥n.</em
          >
        </p>

        <div class="form-group">
          <button onclick="fuerzaBruta()" class="btn-danger">
            üîç Ejecutar Fuerza Bruta
          </button>
        </div>

        <!-- Result: total combinations -->
        <div
          id="resultado-fb"
          class="alert alert-info"
          style="display: none"
        ></div>

        <!-- Table of dangerous combinations -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Libros (4)</th>
                <th>Peso Total (Kg)</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="tabla-fb">
              <!-- Los datos se cargan din√°micamente -->
            </tbody>
          </table>
        </div>

        <div id="loading-fb" class="loading">Procesando combinaciones...</div>
      </div>

      <!-- ===== SECTION: Backtracking ===== -->
      <div class="section fade-in">
        <h2>‚úÖ Backtracking ‚Äì Estanter√≠a √ìptima</h2>
        <p>
          Este algoritmo usa <strong>backtracking</strong> para encontrar la
          combinaci√≥n de libros que
          <strong>maximiza el valor total (COP)</strong> sin exceder la
          capacidad m√°xima de <strong>8 Kg</strong> por estante.
        </p>
        <p>
          <em
            >T√©cnica: Exploraci√≥n con poda - descarta ramas que exceden el
            peso.</em
          >
        </p>

        <div class="form-group">
          <button onclick="backtracking()" class="btn-success">
            üéØ Ejecutar Backtracking
          </button>
        </div>

        <!-- Result: best value found -->
        <div
          id="resultado-bt"
          class="alert alert-success"
          style="display: none"
        ></div>

        <!-- Table of optimal shelves -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Estanter√≠a</th>
                <th>Libros Asignados</th>
                <th>Peso Total (Kg)</th>
                <th>Valor Total (COP)</th>
              </tr>
            </thead>
            <tbody id="tabla-bt">
              <!-- Los datos se cargan din√°micamente -->
            </tbody>
          </table>
        </div>

        <div id="loading-bt" class="loading">Calculando soluci√≥n √≥ptima...</div>
      </div>

      <!-- ===== SECTION: Algorithms Explanation ===== -->
      <div class="section fade-in">
        <h2>üìñ Explicaci√≥n de los Algoritmos</h2>

        <h3>Fuerza Bruta</h3>
        <p>
          La fuerza bruta explora
          <strong>todas las combinaciones posibles</strong> de 4 libros usando 4
          bucles anidados. Para cada combinaci√≥n, suma los pesos y verifica si
          supera el umbral de 8 Kg. Es simple pero ineficiente para grandes
          conjuntos de datos.
        </p>

        <h3>Backtracking</h3>
        <p>
          El backtracking es una t√©cnica de
          <strong>exploraci√≥n sistem√°tica</strong> que construye soluciones
          incrementalmente. En cada paso decide si incluir o excluir un libro.
          Si el peso acumulado excede 8 Kg,
          <strong>retrocede (backtrack)</strong> y prueba otra rama. Esto es m√°s
          eficiente que la fuerza bruta porque "poda" ramas inv√°lidas
          tempranamente.
        </p>
      </div>
    </div>

    <!-- ========== FOOTER ========== -->
    <footer>
      <p>Sistema de Gesti√≥n de Biblioteca ¬© 2025</p>
    </footer>

    <!-- ========== SCRIPTS ========== -->
    <script>
      // API base URL
      const API_BASE = "http://127.0.0.1:8000";

      /**
       * Run Brute Force algorithm
       * Uses: GET /estanteria/deficiente
       * Returns: All 4-book combinations that exceed 8 kg
       */
      async function fuerzaBruta() {
        mostrarLoading("loading-fb", true);
        document.getElementById("resultado-fb").style.display = "none";

        try {
          const datos = await fetchAPI(`${API_BASE}/estanteria/deficiente`);
          renderTablaFuerzaBruta(datos);

          // Mostrar resumen
          const resultadoDiv = document.getElementById("resultado-fb");
          resultadoDiv.innerHTML = `
                    <strong>Resultado:</strong> Se encontraron 
                    <strong>${
                      datos.total_combinaciones_encontradas ||
                      datos.combinaciones?.length ||
                      0
                    }</strong> 
                    combinaciones peligrosas (peso > 8 Kg).
                `;
          resultadoDiv.style.display = "block";
        } catch (error) {
          mostrarError(
            "Error al ejecutar fuerza bruta (¬øhay al menos 4 libros?)"
          );
        }

        mostrarLoading("loading-fb", false);
      }

      /**
       * Run Backtracking algorithm
       * Uses: GET /estanteria/optima
       * Returns: Optimal assignment of books to shelves
       */
      async function backtracking() {
        mostrarLoading("loading-bt", true);
        document.getElementById("resultado-bt").style.display = "none";

        try {
          const datos = await fetchAPI(`${API_BASE}/estanteria/optima`);
          renderTablaBacktracking(datos);

          // Mostrar resumen
          const resultadoDiv = document.getElementById("resultado-bt");
          const totalValor =
            datos.resultado?.reduce((sum, r) => sum + r.precio_total, 0) || 0;
          resultadoDiv.innerHTML = `
                    <strong>Soluci√≥n √≥ptima encontrada:</strong> 
                    ${
                      datos.resultado?.length || 0
                    } estanter√≠a(s) configurada(s) con un valor total de 
                    <strong>$${totalValor.toLocaleString()} COP</strong>.
                `;
          resultadoDiv.style.display = "block";
        } catch (error) {
          mostrarError("Error al ejecutar backtracking");
        }

        mostrarLoading("loading-bt", false);
      }

      // ========== HELPER FUNCTIONS ==========

      /**
       * Render table of dangerous combinations (Brute Force)
       */
      function renderTablaFuerzaBruta(datos) {
        const tabla = document.getElementById("tabla-fb");
        tabla.innerHTML = "";

        const combinaciones = datos.combinaciones || [];

        combinaciones.forEach((c, index) => {
          const tr = document.createElement("tr");

          // Extraer t√≠tulos de los libros
          const titulos = c.libros
            .map((l) => (typeof l === "string" ? l : l.titulo))
            .join(", ");

          tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${titulos}</td>
                    <td><strong>${c.peso_total.toFixed(2)}</strong></td>
                    <td><span class="badge badge-danger">‚ö†Ô∏è Excede l√≠mite</span></td>
                `;
          tabla.appendChild(tr);
        });

        if (combinaciones.length === 0) {
          tabla.innerHTML =
            '<tr><td colspan="4">No se encontraron combinaciones peligrosas</td></tr>';
        }
      }

      /**
       * Render table of optimal shelves (Backtracking)
       */
      function renderTablaBacktracking(datos) {
        const tabla = document.getElementById("tabla-bt");
        tabla.innerHTML = "";

        const resultado = datos.resultado || [];

        resultado.forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td><strong>Estanter√≠a ${r.estanteria}</strong></td>
                    <td>${r.libros.join(", ")}</td>
                    <td>${r.peso_total.toFixed(2)} Kg</td>
                    <td><span class="badge badge-success">$${r.precio_total.toLocaleString()}</span></td>
                `;
          tabla.appendChild(tr);
        });

        if (resultado.length === 0) {
          tabla.innerHTML =
            '<tr><td colspan="4">No se pudo calcular la asignaci√≥n √≥ptima</td></tr>';
        }
      }

      function mostrarLoading(id, show) {
        const el = document.getElementById(id);
        if (el) el.classList.toggle("active", show);
      }

      function mostrarExito(msg) {
        alert("‚úÖ " + msg);
      }

      function mostrarError(msg) {
        alert("‚ùå " + msg);
      }
    </script>
  </body>
</html>
