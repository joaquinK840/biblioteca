<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- ============================================
          LIBRARY - Loans Management
          Loans, returns and history (Stack)
          ============================================ -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <title>PrÃ©stamos - Biblioteca</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
    <script src="/static/js/main.js"></script>
  </head>
  <body>
    <!-- ========== HEADER ========== -->
    <header>
      <h1>ğŸ“‹ GestiÃ³n de PrÃ©stamos</h1>
      <p>PrÃ©stamos, devoluciones e historial LIFO</p>
    </header>

    <!-- ========== NAVIGATION ========== -->
    <nav>
      <a href="/">ğŸ  Inicio</a>
      <a href="/templates/libros">ğŸ“– Libros</a>
      <a href="/templates/usuarios">ğŸ‘¤ Usuarios</a>
      <a href="/templates/prestamos" class="active">ğŸ“‹ PrÃ©stamos</a>
      <a href="/templates/reservas">ğŸ”– Reservas</a>
      <a href="/templates/estanterias">ğŸ“š EstanterÃ­as</a>
    </nav>

    <!-- ========== MAIN CONTENT ========== -->
    <div class="container">
      <!-- ===== SECTION: Active Loans List ===== -->
      <div class="section fade-in">
        <h2>ğŸ“‹ Lista de PrÃ©stamos Activos</h2>

        <div class="form-group">
          <button onclick="cargarPrestamos()">ğŸ”„ Cargar PrÃ©stamos</button>
        </div>

        <!-- Loans table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>ISBN</th>
                <th>Fecha PrÃ©stamo</th>
                <th>Fecha DevoluciÃ³n</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="tabla-prestamos">
              <!-- Los datos se cargan dinÃ¡micamente -->
            </tbody>
          </table>
        </div>

        <div id="loading-prestamos" class="loading">Cargando...</div>
      </div>

      <!-- ===== SECTION: Create Loan ===== -->
      <div class="section fade-in">
        <h2>â• Crear Nuevo PrÃ©stamo</h2>
        <p>
          Al crear un prÃ©stamo, se descuenta automÃ¡ticamente el stock del libro.
        </p>

        <div class="form-group">
          <input type="text" id="p_uid" placeholder="ID del Usuario" />
          <input type="text" id="p_isbn" placeholder="ISBN del Libro" />
          <button onclick="crearPrestamo()" class="btn-success">
            âœ… Crear PrÃ©stamo
          </button>
        </div>
      </div>

      <!-- ===== SECTION: Register Return ===== -->
      <div class="section fade-in">
        <h2>â†©ï¸ Registrar DevoluciÃ³n</h2>
        <p>
          Al devolver, se incrementa el stock y se verifica si hay reservas
          pendientes (bÃºsqueda binaria + cola FIFO).
        </p>

        <div class="form-group">
          <input
            type="text"
            id="devol_prestamo"
            placeholder="ID del PrÃ©stamo"
          />
          <button onclick="registrarDevolucion()" class="btn-warning">
            ğŸ“¥ Registrar DevoluciÃ³n
          </button>
        </div>
      </div>

      <!-- ===== SECTION: User History (LIFO Stack) ===== -->
      <div class="section fade-in">
        <h2>ğŸ“š Historial del Usuario (Pila LIFO)</h2>
        <p>
          El historial usa una estructura de Pila: el Ãºltimo prÃ©stamo aparece
          primero.
        </p>

        <div class="form-group">
          <input type="text" id="hist_uid" placeholder="ID del Usuario" />
          <button onclick="verHistorial()">ğŸ” Ver Historial</button>
        </div>

        <!-- History table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID PrÃ©stamo</th>
                <th>Usuario</th>
                <th>ISBN</th>
                <th>Fecha PrÃ©stamo</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="tabla-historial">
              <!-- Los datos se cargan dinÃ¡micamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ========== FOOTER ========== -->
    <footer>
      <p>Sistema de GestiÃ³n de Biblioteca Â© 2025</p>
    </footer>

    <!-- ========== SCRIPTS ========== -->
    <script>
      // API base URL
      const API_BASE = "http://127.0.0.1:8000";

      /**
       * Load all loans from the API
       * Uses: GET /prestamos/
       */
      async function cargarPrestamos() {
        mostrarLoading("loading-prestamos", true);
        try {
          const datos = await fetchAPI(`${API_BASE}/prestamos/`);
          renderTablaPrestamos(datos);
        } catch (error) {
          mostrarError("Error al cargar prÃ©stamos");
        }
        mostrarLoading("loading-prestamos", false);
      }

      /**
       * Create a new loan
       * Uses: POST /prestamos/
       * Requires: valid user, book with stock > 0
       */
      async function crearPrestamo() {
        const data = {
          user_id: document.getElementById("p_uid").value.trim(),
          isbn: document.getElementById("p_isbn").value.trim(),
        };

        if (!data.user_id || !data.isbn) {
          mostrarError("Usuario e ISBN son obligatorios");
          return;
        }

        try {
          await fetchAPI(`${API_BASE}/prestamos/`, "POST", data);
          mostrarExito("PrÃ©stamo creado exitosamente");
          document.getElementById("p_uid").value = "";
          document.getElementById("p_isbn").value = "";
          cargarPrestamos();
        } catch (error) {
          mostrarError(
            "Error al crear prÃ©stamo (Â¿usuario/libro invÃ¡lido o sin stock?)"
          );
        }
      }

      /**
       * Register loan return
       * Uses: PUT /prestamos/devolver/{id}
       * Triggers: binary search + reservation assignment
       */
      async function registrarDevolucion() {
        const id = document.getElementById("devol_prestamo").value.trim();

        if (!id) {
          mostrarError("Ingresa el ID del prÃ©stamo");
          return;
        }

        try {
          await fetchAPI(`${API_BASE}/prestamos/devolver/${id}`, "PUT");
          mostrarExito(
            "DevoluciÃ³n registrada. Si habÃ­a reservas, se asignÃ³ automÃ¡ticamente."
          );
          document.getElementById("devol_prestamo").value = "";
          cargarPrestamos();
        } catch (error) {
          mostrarError("Error al registrar devoluciÃ³n");
        }
      }

      /**
       * View user's loan history (LIFO Stack)
       * Uses: GET /prestamos/historial/{user_id}
       */
      async function verHistorial() {
        const uid = document.getElementById("hist_uid").value.trim();

        if (!uid) {
          mostrarError("Ingresa el ID del usuario");
          return;
        }

        try {
          const datos = await fetchAPI(
            `${API_BASE}/prestamos/historial/${uid}`
          );
          renderTablaHistorial(datos);
          mostrarExito(`Historial cargado: ${datos.length} prÃ©stamo(s)`);
        } catch (error) {
          renderTablaHistorial([]);
          mostrarError("Error al cargar historial");
        }
      }

      // ========== HELPER FUNCTIONS ==========

      /**
       * Render the loans table
       */
      function renderTablaPrestamos(prestamos) {
        const tabla = document.getElementById("tabla-prestamos");
        tabla.innerHTML = "";

        prestamos.forEach((p) => {
          const tr = document.createElement("tr");
          const devuelto = p.devuelto === "1" || p.devuelto === true;
          tr.innerHTML = `
                    <td>${p.prestamo_id}</td>
                    <td>${p.user_id}</td>
                    <td>${p.isbn}</td>
                    <td>${p.fecha_prestamo}</td>
                    <td>${p.fecha_devolucion || "-"}</td>
                    <td><span class="badge ${
                      devuelto ? "badge-success" : "badge-warning"
                    }">${devuelto ? "Devuelto" : "Activo"}</span></td>
                `;
          tabla.appendChild(tr);
        });
      }

      /**
       * Render the history table (Stack)
       */
      function renderTablaHistorial(historial) {
        const tabla = document.getElementById("tabla-historial");
        tabla.innerHTML = "";

        historial.forEach((p) => {
          const tr = document.createElement("tr");
          const devuelto = p.devuelto === "1" || p.devuelto === true;
          tr.innerHTML = `
                    <td>${p.prestamo_id}</td>
                    <td>${p.user_id}</td>
                    <td>${p.isbn}</td>
                    <td>${p.fecha_prestamo}</td>
                    <td><span class="badge ${
                      devuelto ? "badge-success" : "badge-warning"
                    }">${devuelto ? "Devuelto" : "Activo"}</span></td>
                `;
          tabla.appendChild(tr);
        });
      }

      function mostrarLoading(id, show) {
        const el = document.getElementById(id);
        if (el) el.classList.toggle("active", show);
      }

      function mostrarExito(msg) {
        alert("âœ… " + msg);
      }

      function mostrarError(msg) {
        alert("âŒ " + msg);
      }

      // Load loans on page start
      document.addEventListener("DOMContentLoaded", cargarPrestamos);
    </script>
  </body>
</html>
