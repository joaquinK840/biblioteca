<!DOCTYPE html>
<html lang="es">
  <head>
    <!-- ============================================
          LIBRARY - Reservations Management
          FIFO queue for out-of-stock books
          ============================================ -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg" />
    <title>Reservas - Biblioteca</title>
    <link rel="stylesheet" href="/static/css/styles.css" />
    <script src="/static/js/main.js"></script>
  </head>
  <body>
    <!-- ========== HEADER ========== -->
    <header>
      <h1>ğŸ”– GestiÃ³n de Reservas</h1>
      <p>Cola de espera FIFO para libros sin stock</p>
    </header>

    <!-- ========== NAVIGATION ========== -->
    <nav>
      <a href="/">ğŸ  Inicio</a>
      <a href="/templates/libros">ğŸ“– Libros</a>
      <a href="/templates/usuarios">ğŸ‘¤ Usuarios</a>
      <a href="/templates/prestamos">ğŸ“‹ PrÃ©stamos</a>
      <a href="/templates/reservas" class="active">ğŸ”– Reservas</a>
      <a href="/templates/estanterias">ğŸ“š EstanterÃ­as</a>
    </nav>

    <!-- ========== MAIN CONTENT ========== -->
    <div class="container">
      <!-- ===== SECTION: Reservations List ===== -->
      <div class="section fade-in">
        <h2>ğŸ“‹ Lista de Reservas</h2>
        <p>
          Las reservas solo se pueden crear cuando el libro tiene stock = 0.
        </p>

        <div class="form-group">
          <button onclick="cargarReservas()">ğŸ”„ Cargar Reservas</button>
        </div>

        <!-- Reservations table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>ID Reserva</th>
                <th>Usuario</th>
                <th>ISBN</th>
                <th>Fecha Reserva</th>
              </tr>
            </thead>
            <tbody id="tabla-reservas">
              <!-- Los datos se cargan dinÃ¡micamente -->
            </tbody>
          </table>
        </div>

        <div id="loading-reservas" class="loading">Cargando...</div>
      </div>

      <!-- ===== SECTION: Create Reservation ===== -->
      <div class="section fade-in">
        <h2>â• Crear Nueva Reserva</h2>
        <p>
          Solo se permite reservar si el libro NO tiene stock disponible (stock
          = 0).
        </p>

        <div class="form-group">
          <input type="text" id="r_uid" placeholder="ID del Usuario" />
          <input type="text" id="r_isbn" placeholder="ISBN del Libro" />
          <button onclick="crearReserva()" class="btn-success">
            âœ… Crear Reserva
          </button>
        </div>
      </div>

      <!-- ===== SECTION: FIFO Queue per Book ===== -->
      <div class="section fade-in">
        <h2>ğŸ“š Cola de Espera FIFO</h2>
        <p>
          Visualiza la cola de reservas para un libro especÃ­fico. El primero en
          la lista serÃ¡ el prÃ³ximo en recibir el libro cuando se devuelva.
        </p>

        <div class="form-group">
          <input type="text" id="cola_isbn" placeholder="ISBN del Libro" />
          <button onclick="verCola()">ğŸ” Ver Cola</button>
        </div>

        <!-- FIFO queue table -->
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>PosiciÃ³n</th>
                <th>ID Reserva</th>
                <th>Usuario</th>
                <th>Fecha Reserva</th>
              </tr>
            </thead>
            <tbody id="tabla-cola">
              <!-- Los datos se cargan dinÃ¡micamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ========== FOOTER ========== -->
    <footer>
      <p>Sistema de GestiÃ³n de Biblioteca Â© 2025</p>
    </footer>

    <!-- ========== SCRIPTS ========== -->
    <script>
      // API base URL
      const API_BASE = "http://127.0.0.1:8000";

      /**
       * Load all reservations from the API
       * Uses: GET /reservas/
       */
      async function cargarReservas() {
        mostrarLoading("loading-reservas", true);
        try {
          const datos = await fetchAPI(`${API_BASE}/reservas/`);
          renderTablaReservas(datos);
        } catch (error) {
          mostrarError("Error al cargar reservas");
        }
        mostrarLoading("loading-reservas", false);
      }

      /**
       * Create a new reservation
       * Uses: POST /reservas/
       * Requirement: The book must have stock = 0
       */
      async function crearReserva() {
        const data = {
          user_id: document.getElementById("r_uid").value.trim(),
          isbn: document.getElementById("r_isbn").value.trim(),
        };

        if (!data.user_id || !data.isbn) {
          mostrarError("Usuario e ISBN son obligatorios");
          return;
        }

        try {
          await fetchAPI(`${API_BASE}/reservas/`, "POST", data);
          mostrarExito("Reserva creada exitosamente");
          document.getElementById("r_uid").value = "";
          document.getElementById("r_isbn").value = "";
          cargarReservas();
        } catch (error) {
          mostrarError("Error al crear reserva (Â¿el libro aÃºn tiene stock?)");
        }
      }

      /**
       * View FIFO queue of reservations for a specific book
       * Uses: GET /reservas/cola/{isbn}
       */
      async function verCola() {
        const isbn = document.getElementById("cola_isbn").value.trim();

        if (!isbn) {
          mostrarError("Ingresa el ISBN del libro");
          return;
        }

        try {
          const datos = await fetchAPI(`${API_BASE}/reservas/cola/${isbn}`);
          renderTablaCola(datos);
          mostrarExito(`Cola cargada: ${datos.length} reserva(s) en espera`);
        } catch (error) {
          renderTablaCola([]);
          mostrarError("Error al cargar la cola");
        }
      }

      // ========== HELPER FUNCTIONS ==========

      /**
       * Render the reservations table
       */
      function renderTablaReservas(reservas) {
        const tabla = document.getElementById("tabla-reservas");
        tabla.innerHTML = "";

        reservas.forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td>${r.reserva_id}</td>
                    <td>${r.user_id}</td>
                    <td>${r.isbn}</td>
                    <td>${r.fecha_reserva}</td>
                `;
          tabla.appendChild(tr);
        });
      }

      /**
       * Render the FIFO queue table with positions
       */
      function renderTablaCola(cola) {
        const tabla = document.getElementById("tabla-cola");
        tabla.innerHTML = "";

        cola.forEach((r, index) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                    <td><span class="badge ${
                      index === 0 ? "badge-success" : "badge-warning"
                    }">${index + 1}Â°</span></td>
                    <td>${r.reserva_id}</td>
                    <td>${r.user_id}</td>
                    <td>${r.fecha_reserva}</td>
                `;
          tabla.appendChild(tr);
        });
      }

      function mostrarLoading(id, show) {
        const el = document.getElementById(id);
        if (el) el.classList.toggle("active", show);
      }

      function mostrarExito(msg) {
        alert("âœ… " + msg);
      }

      function mostrarError(msg) {
        alert("âŒ " + msg);
      }

      // Load reservations on page start
      document.addEventListener("DOMContentLoaded", cargarReservas);
    </script>
  </body>
</html>
